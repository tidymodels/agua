<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="agua">
<title>Model tuning • agua</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.9/font.css" rel="stylesheet">
<!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Model tuning">
<meta property="og:description" content="agua">
<meta property="og:image" content="https://agua.tidymodels.org/logo.svg">
<meta name="robots" content="noindex">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><script defer data-domain="agua.tidymodels.org,all.tidymodels.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-none" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">agua</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">0.1.3.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/agua.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/auto_ml.html">Automatic machine learning</a>
    <a class="dropdown-item" href="../articles/parallel.html">Parallel processing with agua and h2o</a>
    <a class="dropdown-item" href="../articles/tune.html">Model tuning</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/tidymodels/agua/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Model tuning</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/tidymodels/agua/blob/HEAD/vignettes/articles/tune.Rmd" class="external-link"><code>vignettes/articles/tune.Rmd</code></a></small>
      <div class="d-none name"><code>tune.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="hyper-parameter-tuning-with-agua">Hyper-parameter tuning with agua<a class="anchor" aria-label="anchor" href="#hyper-parameter-tuning-with-agua"></a>
</h2>
<p>agua sets up the infrastructure for the tune package to enable
optimization of h2o models. Similar to other models, we label the
hyperparameter with the <code><a href="https://hardhat.tidymodels.org/reference/tune.html" class="external-link">tune()</a></code> placeholder and feed them
into <code>tune_*()</code> functions such as <code>tune_grid()</code>
and <code>tune_bayes()</code>.</p>
<p>Let’s go through the example from <a href="https://tune.tidymodels.org/articles/tune.html" class="external-link">Introduction to
tune</a> with the Ames housing data.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidymodels.tidymodels.org" class="external-link">tidymodels</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://agua.tidymodels.org/">agua</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu">doParallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html" class="external-link">registerDoParallel</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/h2o-server.html">h2o_start</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: JAVA not found, H2O may take minutes trying to connect.</span></span>
<span><span class="co">#&gt; Warning in h2o.clusterInfo(): </span></span>
<span><span class="co">#&gt; Your H2O cluster version is (5 months and 15 days) old. There may be a newer version available.</span></span>
<span><span class="co">#&gt; Please download and install the latest version from: https://h2o-release.s3.amazonaws.com/h2o/latest_stable.html</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">ames</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">4595</span><span class="op">)</span></span>
<span><span class="va">data_split</span> <span class="op">&lt;-</span> <span class="va">ames</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">mutate</span><span class="op">(</span>Sale_Price <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/h2o/man/H2OFrame.html" class="external-link">log10</a></span><span class="op">(</span><span class="va">Sale_Price</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">initial_split</span><span class="op">(</span>strata <span class="op">=</span> <span class="va">Sale_Price</span><span class="op">)</span></span>
<span><span class="va">ames_train</span> <span class="op">&lt;-</span> <span class="fu">training</span><span class="op">(</span><span class="va">data_split</span><span class="op">)</span></span>
<span><span class="va">ames_test</span> <span class="op">&lt;-</span> <span class="fu">testing</span><span class="op">(</span><span class="va">data_split</span><span class="op">)</span></span>
<span><span class="va">cv_splits</span> <span class="op">&lt;-</span> <span class="fu">vfold_cv</span><span class="op">(</span><span class="va">ames_train</span>, v <span class="op">=</span> <span class="fl">10</span>, strata <span class="op">=</span> <span class="va">Sale_Price</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ames_rec</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu">recipe</span><span class="op">(</span><span class="va">Sale_Price</span> <span class="op">~</span> <span class="va">Gr_Liv_Area</span> <span class="op">+</span> <span class="va">Longitude</span> <span class="op">+</span> <span class="va">Latitude</span>, data <span class="op">=</span> <span class="va">ames_train</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">step_log</span><span class="op">(</span><span class="va">Gr_Liv_Area</span>, base <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">step_ns</span><span class="op">(</span><span class="va">Longitude</span>, deg_free <span class="op">=</span> <span class="fu"><a href="https://hardhat.tidymodels.org/reference/tune.html" class="external-link">tune</a></span><span class="op">(</span><span class="st">"long df"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">step_ns</span><span class="op">(</span><span class="va">Latitude</span>, deg_free <span class="op">=</span> <span class="fu"><a href="https://hardhat.tidymodels.org/reference/tune.html" class="external-link">tune</a></span><span class="op">(</span><span class="st">"lat df"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lm_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://parsnip.tidymodels.org/reference/linear_reg.html" class="external-link">linear_reg</a></span><span class="op">(</span>penalty <span class="op">=</span> <span class="fu"><a href="https://hardhat.tidymodels.org/reference/tune.html" class="external-link">tune</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_engine.html" class="external-link">set_engine</a></span><span class="op">(</span><span class="st">"h2o"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lm_wflow</span> <span class="op">&lt;-</span> <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">lm_mod</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">add_recipe</span><span class="op">(</span><span class="va">ames_rec</span><span class="op">)</span></span>
<span></span>
<span><span class="va">grid</span> <span class="op">&lt;-</span> <span class="va">lm_wflow</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://hardhat.tidymodels.org/reference/hardhat-extract.html" class="external-link">extract_parameter_set_dials</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">grid_regular</span><span class="op">(</span>levels <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ames_res</span> <span class="op">&lt;-</span> <span class="fu">tune_grid</span><span class="op">(</span></span>
<span>  <span class="va">lm_wflow</span>,</span>
<span>  resamples <span class="op">=</span> <span class="va">cv_splits</span>,</span>
<span>  grid <span class="op">=</span> <span class="va">grid</span>,</span>
<span>  control <span class="op">=</span> <span class="fu">control_grid</span><span class="op">(</span>save_pred <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    backend_options <span class="op">=</span> <span class="fu"><a href="../reference/h2o_tune.html">agua_backend_options</a></span><span class="op">(</span>parallelism <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">ames_res</span></span>
<span><span class="co">#&gt; # Tuning results</span></span>
<span><span class="co">#&gt; # 10-fold cross-validation using stratification </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 10 × 5</span></span></span>
<span><span class="co">#&gt;    splits             id     .metrics           .notes   .predictions</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> <span style="color: #949494;">&lt;split [1976/221]&gt;</span> Fold01 <span style="color: #949494;">&lt;tibble [250 × 7]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> <span style="color: #949494;">&lt;split [1976/221]&gt;</span> Fold02 <span style="color: #949494;">&lt;tibble [250 × 7]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> <span style="color: #949494;">&lt;split [1976/221]&gt;</span> Fold03 <span style="color: #949494;">&lt;tibble [250 × 7]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> <span style="color: #949494;">&lt;split [1976/221]&gt;</span> Fold04 <span style="color: #949494;">&lt;tibble [250 × 7]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> <span style="color: #949494;">&lt;split [1977/220]&gt;</span> Fold05 <span style="color: #949494;">&lt;tibble [250 × 7]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> <span style="color: #949494;">&lt;split [1977/220]&gt;</span> Fold06 <span style="color: #949494;">&lt;tibble [250 × 7]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> <span style="color: #949494;">&lt;split [1978/219]&gt;</span> Fold07 <span style="color: #949494;">&lt;tibble [250 × 7]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> <span style="color: #949494;">&lt;split [1978/219]&gt;</span> Fold08 <span style="color: #949494;">&lt;tibble [250 × 7]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> <span style="color: #949494;">&lt;split [1979/218]&gt;</span> Fold09 <span style="color: #949494;">&lt;tibble [250 × 7]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> <span style="color: #949494;">&lt;split [1980/217]&gt;</span> Fold10 <span style="color: #949494;">&lt;tibble [250 × 7]&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span> <span style="color: #949494;">&lt;tibble&gt;</span>    </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; There were issues with some computations:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   - Warning(s) x10: data.table cannot be used without R package bit64 version 0...</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Run `show_notes(.Last.tune.result)` for more information.</span></span></code></pre></div>
<p>The syntax is the same, we provide a workflow and the grid of
hyperparameters, then <code>tune_grid()</code> returns cross validation
performances for every parameterization per resample. There are 2
differences to note when tuning h2o models:</p>
<ul>
<li><p>We have to call <code><a href="../reference/h2o-server.html">h2o_start()</a></code> beforehand to enable all
the h2o side of computations.</p></li>
<li><p>We can further configure tuning on the h2o server by supplying
the <code>backend_options</code> argument in <code>control_grid()</code>
with an <code><a href="../reference/h2o_tune.html">agua_backend_options()</a></code> object. Currently there is
only one supported argument, <code>parallelism</code>, which specifies
the number of models built in parallel. In the example above, we tell
the h2o server to build 5 models in parallel. Note the parallelism on
the h2o server is different than a parallel backend in R such as
<code>doParallel</code>. The former parallelizes over model parameters
while the latter over parameters in the preprocessor. See the next
section for more details.</p></li>
</ul>
<p>Other functions in tune for working with tuning results such as
<code><a href="https://tune.tidymodels.org/reference/collect_predictions.html" class="external-link">collect_metrics()</a></code>, <code>collect_predictions()</code> and
<code><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot()</a></code> will also recognize <code>ames_res</code> and
work as expected.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://tune.tidymodels.org/reference/collect_predictions.html" class="external-link">collect_metrics</a></span><span class="op">(</span><span class="va">ames_res</span>, summarize <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2,500 × 8</span></span></span>
<span><span class="co">#&gt;    id      penalty `long df` `lat df` .metric .estimator .estimate .config</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> Fold01    1<span style="color: #949494;">e</span><span style="color: #BB0000;">-10</span>         1        1 rmse    standard      0.115  Prepro…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> Fold01    1<span style="color: #949494;">e</span><span style="color: #BB0000;">-10</span>         1        1 rsq     standard      0.550  Prepro…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> Fold02    1<span style="color: #949494;">e</span><span style="color: #BB0000;">-10</span>         1        1 rmse    standard      0.112  Prepro…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> Fold02    1<span style="color: #949494;">e</span><span style="color: #BB0000;">-10</span>         1        1 rsq     standard      0.603  Prepro…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> Fold03    1<span style="color: #949494;">e</span><span style="color: #BB0000;">-10</span>         1        1 rmse    standard      0.116  Prepro…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> Fold03    1<span style="color: #949494;">e</span><span style="color: #BB0000;">-10</span>         1        1 rsq     standard      0.563  Prepro…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> Fold04    1<span style="color: #949494;">e</span><span style="color: #BB0000;">-10</span>         1        1 rmse    standard      0.112  Prepro…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> Fold04    1<span style="color: #949494;">e</span><span style="color: #BB0000;">-10</span>         1        1 rsq     standard      0.581  Prepro…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> Fold05    1<span style="color: #949494;">e</span><span style="color: #BB0000;">-10</span>         1        1 rmse    standard      0.099<span style="text-decoration: underline;">8</span> Prepro…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> Fold05    1<span style="color: #949494;">e</span><span style="color: #BB0000;">-10</span>         1        1 rsq     standard      0.637  Prepro…</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 2,490 more rows</span></span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span><span class="va">ames_res</span>, metric <span class="op">=</span> <span class="st">"rmse"</span><span class="op">)</span></span></code></pre></div>
<p><img src="tune_files/figure-html/tune-plot-1.png" width="95%"></p>
</div>
<div class="section level2">
<h2 id="tuning-internals">Tuning internals<a class="anchor" aria-label="anchor" href="#tuning-internals"></a>
</h2>
<p>For users interested in the performance characteristics of tuning h2o
models with agua, it is helpful to know some inner workings of h2o. agua
uses the <code><a href="https://rdrr.io/pkg/h2o/man/h2o.grid.html" class="external-link">h2o::h2o.grid()</a></code> function for tuning model
parameters, which accepts a list of possible combinations and search for
the optimal one for a given dataset.</p>
<p>In the example above, we have three tuning parameters of two
types:</p>
<ul>
<li><p>tuning parameters in the model: <code>penalty</code>.</p></li>
<li><p>tuning parameters in the preprocessor: <code>long df</code> and
<code>lat df</code>.</p></li>
</ul>
<p>This can be extracted by
<code><a href="https://hardhat.tidymodels.org/reference/hardhat-extract.html" class="external-link">extract_parameter_set_dials()</a></code></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://hardhat.tidymodels.org/reference/hardhat-extract.html" class="external-link">extract_parameter_set_dials</a></span><span class="op">(</span><span class="va">lm_wflow</span><span class="op">)</span></span>
<span><span class="co">#&gt; Collection of 3 parameters for tuning</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;  identifier     type    object</span></span>
<span><span class="co">#&gt;     penalty  penalty nparam[+]</span></span>
<span><span class="co">#&gt;     long df deg_free nparam[+]</span></span>
<span><span class="co">#&gt;      lat df deg_free nparam[+]</span></span></code></pre></div>
<p>Since <code>h2o.grid</code> is only responsible for optimizing model
parameters, the preprocessor parameters <code>long df</code> and
<code>lat df</code> will be iterated as usual on the R side (also for
this reason you can’t use agua with
<code>control_grid(parallel_over = 'everything')</code>). Once a certain
combination of them is chosen, agua will engineer all the relevant
features and pass the data and model definitions to
<code>h2o_grid()</code>. For example, say we choose the preprocess
parameters to be <code>long df = 4</code> and <code>lat df = 1</code>,
the analysis set in one particular fold becomes</p>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1,976 × 7</span></span></span>
<span><span class="co">#&gt;    Gr_Liv_Area Sale_Price Longitude_ns_1 Longitude_ns_2 Longitude_ns_3</span></span>
<span><span class="co">#&gt;          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>      <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>        2.95       5.02        0.238           0.564           0.211</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>        2.95       5.10        0.440           0.466           0.149</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>        3.04       5.02        0.452           0.457           0.145</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>        3.04       4.94        0.445           0.462           0.147</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>        2.96       5.00        0.002<span style="text-decoration: underline;">76</span>        -<span style="color: #BB0000;">0.070</span><span style="color: #BB0000; text-decoration: underline;">5</span>          0.182</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>        3.01       4.83        0.023<span style="text-decoration: underline;">5</span>         -<span style="color: #BB0000;">0.134</span>           0.347</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>        2.95       5.09        0.078<span style="text-decoration: underline;">7</span>         -<span style="color: #BB0000;">0.178</span>           0.459</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>        3.02       5.10        0.109          -<span style="color: #BB0000;">0.186</span>           0.482</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>        3.09       5.11        0.330           0.532           0.180</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>        3.24       4.93        0.317           0.538           0.184</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1,966 more rows</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 2 more variables: Longitude_ns_4 &lt;dbl&gt;, Latitude_ns_1 &lt;dbl&gt;</span></span></span></code></pre>
<p>This is the data frame we will be passing to the h2o server for one
iteration of training. We have now completed computations on the R side
with the rest delegated to the h2o server. For this preprocessor
combination, we have 5 possible choices of the model parameter
<code>penalty</code></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">grid</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">`long df`</span> <span class="op">==</span> <span class="fl">4</span>, <span class="va">`lat df`</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">pull</span><span class="op">(</span><span class="va">penalty</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 1.00e-10 3.16e-08 1.00e-05 3.16e-03 1.00e+00</span></span></code></pre></div>
<p>Then the option
<code>control_grid(backend_options = agua_backend_options(parallelism = 5))</code>
tells the h2o server to build 5 models with these choices in
parallel.</p>
<p>If you have a parallel backend in R like <code>doParallel</code>
registered, combinations of <code>long df</code> and <code>lat df</code>
will be selected in parallel, as is the prepared analysis set. This is
independent of how <code>parallelism</code> is configured on the h2o
server.</p>
<p>Regarding the performance of model evaluation,
<code><a href="https://rdrr.io/pkg/h2o/man/h2o.grid.html" class="external-link">h2o::h2o.grid()</a></code> supports passing in a validation frame but
does not return predictions on that data. In order to compute metrics on
the holdout sample, we have to retrieve the model, convert validation
data into the desired format, predict on it, and convert the results
back to data frames. In the future we hope to get validation predictions
directly thus eliminating excessive data conversions.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/topepo" class="external-link">Max Kuhn</a>, Qiushi Yan, Steven Pawley, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

  </div></footer>
</body>
</html>
